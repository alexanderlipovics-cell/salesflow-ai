<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales Flow AI ¬∑ Lead Chat</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #020611;
        --panel: #111827;
        --panel-glass: rgba(13, 17, 23, 0.9);
        --accent: #00d8a4;
        --accent-dark: #00a97c;
        --text: #f0f6fc;
        --muted: #8b949e;
        --border: rgba(255, 255, 255, 0.08);
        --danger: #ff6575;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #020611, #111b2d 65%, #080c18);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .app-shell {
        width: min(1400px, 100%);
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 1.5rem;
      }

      .sidebar {
        background: rgba(13, 17, 23, 0.85);
        border: 1px solid var(--border);
        border-radius: 22px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        backdrop-filter: blur(10px);
      }

      .logo-area {
        display: flex;
        gap: 0.85rem;
        align-items: center;
      }

      .logo-dot {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: linear-gradient(135deg, #3b82f6, #a855f7);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.35);
      }

      .logo-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .logo-subtitle {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .nav-group {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        margin-bottom: 1rem;
      }

      .nav-label {
        margin: 0;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .nav-link {
        appearance: none;
        border: 1px solid transparent;
        background: transparent;
        color: inherit;
        padding: 0.55rem 0.75rem;
        border-radius: 10px;
        text-align: left;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        gap: 0.35rem;
        align-items: center;
        justify-content: space-between;
        transition: background 0.2s ease, border 0.2s ease;
      }

      .nav-link:hover,
      .nav-link.active {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.08);
      }

      .nav-link[disabled] {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.1rem 0.45rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .badge-pro {
        background: rgba(168, 85, 247, 0.15);
        border-color: rgba(168, 85, 247, 0.4);
        color: #d8b4fe;
      }

      .badge-popular {
        background: rgba(37, 99, 235, 0.15);
        border-color: rgba(59, 130, 246, 0.6);
        color: #bfdbfe;
      }

      .sidebar-footer {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .user-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .user-name {
        margin: 0;
        font-weight: 600;
      }

      .user-role {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .plan-chip {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        text-transform: uppercase;
      }

      .upgrade-btn {
        width: 100%;
        padding: 0.85rem 1rem;
        border-radius: 12px;
      }

      .main {
        background: var(--panel-glass);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 2rem;
        backdrop-filter: blur(12px);
        box-shadow: 0 25px 65px rgba(0, 0, 0, 0.45);
      }

      .view {
        display: none;
        flex-direction: column;
        gap: 1.5rem;
      }

      .view.active {
        display: flex;
      }

      .panel-grid {
        display: grid;
        grid-template-columns: 1.75fr 1fr;
        gap: 1.25rem;
      }

      .panel {
        background: rgba(17, 24, 39, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 18px;
        padding: 1.5rem;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35);
      }

      h1 {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 600;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.15em;
        font-size: 0.75rem;
        color: var(--muted);
        margin: 0 0 0.35rem;
      }

      .muted {
        color: var(--muted);
        margin: 0.25rem 0 0;
      }

      .chat-feed {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: 420px;
        overflow-y: auto;
        margin: 1.25rem 0;
        padding-right: 0.5rem;
      }

      .bubble {
        padding: 0.9rem 1rem;
        border-radius: 12px;
        line-height: 1.45;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.05);
        white-space: pre-wrap;
      }

      .bubble.user {
        background: rgba(0, 216, 164, 0.08);
        border-color: rgba(0, 216, 164, 0.4);
        align-self: flex-end;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      textarea,
      input {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(15, 20, 30, 0.8);
        color: inherit;
        padding: 0.9rem 1rem;
        resize: none;
        font-size: 1rem;
      }

      textarea {
        min-height: 110px;
      }

      textarea:focus,
      input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(0, 216, 164, 0.35);
      }

      .actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      button {
        border: none;
        border-radius: 12px;
        padding: 0.9rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      button.primary {
        background: var(--accent);
        color: #03150e;
        box-shadow: 0 10px 25px rgba(0, 216, 164, 0.35);
      }

      button.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 25px rgba(0, 216, 164, 0.4);
      }

      .status {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.04);
        font-size: 0.9rem;
        min-height: 48px;
        display: flex;
        align-items: center;
      }

      .status[data-type="error"] {
        border-color: rgba(255, 101, 117, 0.35);
        color: var(--danger);
      }

      .status[data-type="success"] {
        border-color: rgba(0, 216, 164, 0.35);
        color: var(--accent);
      }

      .lead-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }

      .chip {
        padding: 0.4rem 0.75rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.11);
        font-size: 0.85rem;
        background: rgba(255, 255, 255, 0.04);
      }

      .info-panel p {
        line-height: 1.5;
      }

      .view-header {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        align-items: flex-start;
      }

      .success-pill {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        border: 1px solid rgba(0, 216, 164, 0.35);
        background: rgba(0, 216, 164, 0.12);
        font-size: 0.9rem;
        color: var(--accent);
      }

      .billing-toggle {
        display: inline-flex;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.25rem;
        background: rgba(17, 24, 39, 0.7);
        width: fit-content;
      }

      .toggle-option {
        border-radius: 999px;
        background: transparent;
        border: none;
        color: var(--muted);
        padding: 0.5rem 1.5rem;
        font-size: 0.9rem;
        box-shadow: none;
      }

      .toggle-option.active {
        background: rgba(0, 216, 164, 0.15);
        color: var(--text);
      }

      .save-pill {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        background: rgba(34, 197, 94, 0.18);
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #bbf7d0;
      }

      .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.25rem;
      }

      .pricing-card {
        background: rgba(15, 23, 42, 0.75);
        border-radius: 20px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: transform 0.25s ease, border 0.25s ease, box-shadow 0.25s ease;
      }

      .pricing-card:hover {
        transform: translateY(-4px);
        border-color: rgba(0, 216, 164, 0.5);
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.45);
      }

      .pricing-card.featured {
        border: 1px solid transparent;
        background: linear-gradient(
            135deg,
            rgba(168, 85, 247, 0.2),
            rgba(59, 130, 246, 0.2)
          ) padding-box,
          linear-gradient(135deg, rgba(168, 85, 247, 0.6), rgba(59, 130, 246, 0.6)) border-box;
        box-shadow: 0 25px 55px rgba(59, 130, 246, 0.35);
      }

      .card-heading {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .plan-name {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .plan-price {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
      }

      .plan-caption {
        margin: 0;
        color: var(--muted);
      }

      .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }

      .feature-list li {
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
        font-size: 0.95rem;
      }

      .feature-list .check {
        color: var(--accent);
        font-weight: 700;
      }

      .pricing-card button {
        width: 100%;
      }

      @media (max-width: 1200px) {
        .panel-grid {
          grid-template-columns: 1fr;
        }

        .chat-feed {
          height: 360px;
        }
      }

      @media (max-width: 980px) {
        body {
          padding: 1rem;
        }

        .app-shell {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="logo-area">
          <div class="logo-dot"></div>
          <div>
            <p class="logo-title">Sales Flow AI</p>
            <p class="logo-subtitle">Deal Operating System</p>
          </div>
        </div>

        <nav>
          <div class="nav-group">
            <p class="nav-label">App</p>
            <button
              type="button"
              class="nav-link active"
              data-view="chat"
              onclick="showView('chat')"
            >
              üí¨ AI Chat
            </button>
          </div>

          <div class="nav-group">
            <p class="nav-label">Wissen</p>
            <button type="button" class="nav-link" disabled>
              üìö Playbooks
            </button>
          </div>

          <div class="nav-group">
            <p class="nav-label">Einstellungen</p>
            <button
              type="button"
              class="nav-link"
              data-view="pricing"
              id="upgradeNavButton"
              onclick="showView('pricing')"
            >
              <span>üí≥ Upgrade</span>
              <span class="badge badge-pro" id="upgradeNavBadge">PRO</span>
            </button>
            <button type="button" class="nav-link" disabled>
              ‚öôÔ∏è Settings
            </button>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="user-card">
            <div>
              <p class="user-name" id="sidebarUserName">Sven Bauer</p>
              <p class="user-role">Revenue Lead</p>
            </div>
            <span class="plan-chip" id="planBadge">FREE</span>
          </div>
          <button
            class="primary upgrade-btn"
            id="sidebarUpgradeButton"
            type="button"
            onclick="showView('pricing')"
          >
            Upgrade
          </button>
        </div>
      </aside>

      <main class="main">
        <div class="view active" id="chat-view" data-view-id="chat">
          <header class="view-header">
            <div>
              <p class="eyebrow">Lead Genius</p>
              <h1>Sales Flow AI ¬∑ Chat</h1>
              <p class="muted">
                Frag nach Taktiken, erw√§hne Leads via @Name oder #lead:123.
              </p>
            </div>
            <div class="success-pill" id="successPill" hidden>Upgrade erfolgreich ‚ú®</div>
          </header>

          <div class="panel-grid">
            <section class="panel">
              <form id="chatForm">
                <label>
                  <textarea
                    id="messageInput"
                    placeholder="Schreibe deine Frage ‚Ä¶ z.‚ÄØB. ‚Äû@Sven ‚Äì was ist der n√§chste Schritt?‚Äú"
                  ></textarea>
                </label>

                <label>
                  <input
                    id="leadInput"
                    type="text"
                    placeholder="Optional: Lead-Namen oder ID hier einf√ºgen (z.‚ÄØB. 874 oder Marie Cron)"
                  />
                </label>

                <div class="actions">
                  <button type="submit" class="primary" id="sendButton">Senden</button>
                  <button type="button" class="secondary" id="analyzeButton">Lead analysieren</button>
                </div>
              </form>

              <div id="chatFeed" class="chat-feed"></div>
            </section>

            <section class="panel info-panel">
              <h2>Lead-Kontext</h2>
              <p>
                Nutze <code>@Lead</code> oder <code>#lead:ID</code> im Chat oder gib den Namen/ID im Feld
                ein. Der Analyze-Button ruft automatisch die Datenbank auf und injiziert den Kontext in
                den Claude-Prompt.
              </p>

              <div class="status" id="statusBanner" data-type="idle">Bereit f√ºr deine Fragen.</div>

              <div class="lead-meta" id="leadMeta"></div>
            </section>
          </div>
        </div>

        <div class="view" id="pricing-view" data-view-id="pricing">
          <header class="view-header">
            <div>
              <p class="eyebrow">Upgrade</p>
              <h1>W√§hle deinen Plan</h1>
              <p class="muted">Upgrade jederzeit, k√ºndige jederzeit</p>
            </div>
          </header>

          <div class="billing-toggle" role="group" aria-label="Abrechnungszeitraum">
            <button
              type="button"
              class="toggle-option active"
              data-billing-interval="month"
            >
              Monatlich
            </button>
            <button type="button" class="toggle-option" data-billing-interval="year">
              J√§hrlich <span class="save-pill">20% sparen</span>
            </button>
          </div>

          <div class="pricing-grid">
            <article class="pricing-card" data-plan="starter">
              <div class="card-heading">
                <p class="plan-name">Starter</p>
                <p class="plan-price" data-plan-price="starter">‚Ç¨79 / Monat</p>
              </div>
              <p class="plan-caption">F√ºr Teams mit ersten Playbooks und kleinen Zielgruppen.</p>
              <ul class="feature-list">
                <li><span class="check">&#10003;</span>500 Leads</li>
                <li><span class="check">&#10003;</span>500 KI-Anfragen/Monat</li>
                <li><span class="check">&#10003;</span>1 Team-Mitglied</li>
                <li><span class="check">&#10003;</span>Email Templates</li>
                <li><span class="check">&#10003;</span>Lead Scanner</li>
              </ul>
              <button type="button" class="primary" data-plan-cta="starter">Jetzt starten</button>
            </article>

            <article class="pricing-card featured" data-plan="pro">
              <div class="card-heading">
                <div>
                  <p class="plan-name">Professional</p>
                  <span class="badge badge-popular">BELIEBT</span>
                </div>
                <p class="plan-price" data-plan-price="pro">‚Ç¨149 / Monat</p>
              </div>
              <p class="plan-caption">Skaliere Outbound und nutze Integrationen & Automatisierung.</p>
              <ul class="feature-list">
                <li><span class="check">&#10003;</span>Unlimited Leads</li>
                <li><span class="check">&#10003;</span>2.000 KI-Anfragen/Monat</li>
                <li><span class="check">&#10003;</span>5 Team-Mitglieder</li>
                <li><span class="check">&#10003;</span>Email & WhatsApp Integration</li>
                <li><span class="check">&#10003;</span>Automatische Sequences</li>
                <li><span class="check">&#10003;</span>RapidAPI Lead Finder</li>
              </ul>
              <button type="button" class="primary" data-plan-cta="pro">Jetzt starten</button>
            </article>

            <article class="pricing-card" data-plan="enterprise">
              <div class="card-heading">
                <p class="plan-name">Enterprise</p>
                <p class="plan-price" data-plan-price="enterprise">‚Ç¨279 / Monat</p>
              </div>
              <p class="plan-caption">F√ºr Enablement-Teams, die SalesOps durchautomatisieren.</p>
              <ul class="feature-list">
                <li><span class="check">&#10003;</span>Unlimited Everything</li>
                <li><span class="check">&#10003;</span>Unlimited KI-Anfragen</li>
                <li><span class="check">&#10003;</span>20 Team-Mitglieder</li>
                <li><span class="check">&#10003;</span>Webhooks & API Access</li>
                <li><span class="check">&#10003;</span>White-Label Option</li>
                <li><span class="check">&#10003;</span>Priority Support</li>
              </ul>
              <button type="button" class="primary" data-plan-cta="enterprise">Jetzt starten</button>
            </article>
          </div>
        </div>
      </main>
    </div>

    <script>
      const chatFeed = document.getElementById("chatFeed");
      const chatForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const leadInput = document.getElementById("leadInput");
      const statusBanner = document.getElementById("statusBanner");
      const leadMeta = document.getElementById("leadMeta");
      const analyzeButton = document.getElementById("analyzeButton");
      const sendButton = document.getElementById("sendButton");

      const successPill = document.getElementById("successPill");
      const planBadge = document.getElementById("planBadge");
      const upgradeNavBadge = document.getElementById("upgradeNavBadge");
      const sidebarUpgradeButton = document.getElementById("sidebarUpgradeButton");
      const navButtons = document.querySelectorAll("[data-view]");
      const views = document.querySelectorAll("[data-view-id]");
      const billingButtons = document.querySelectorAll("[data-billing-interval]");
      const planCTAButtons = document.querySelectorAll("[data-plan-cta]");

      const planPrices = {
        starter: 79,
        pro: 149,
        enterprise: 279,
      };

      const currentUser = {
        id: "user_9321",
        plan: "FREE",
      };

      let currentBillingInterval = "month";
      const conversation = [];
      let isSending = false;

      chatForm.addEventListener("submit", (event) => {
        event.preventDefault();
        sendChat();
      });

      analyzeButton.addEventListener("click", () => {
        sendChat({ action: "analyze_lead_context" });
      });

      messageInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendChat();
        }
      });

      navButtons.forEach((button) => {
        const targetView = button.dataset.view;
        if (!targetView) return;
        button.addEventListener("click", () => showView(targetView));
      });

      billingButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const interval = button.dataset.billingInterval;
          if (interval === currentBillingInterval) return;
          currentBillingInterval = interval;
          updateBillingToggle();
          updatePricingPrices();
        });
      });

      planCTAButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const plan = button.dataset.planCta;
          startCheckout(plan, currentBillingInterval);
        });
      });

      function appendBubble(role, text) {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;
        bubble.textContent = text.trim();
        chatFeed.appendChild(bubble);
        chatFeed.scrollTop = chatFeed.scrollHeight;
      }

      function updateLeadMeta(reference) {
        leadMeta.innerHTML = "";
        if (!reference) {
          return;
        }

        const label = document.createElement("div");
        label.className = "chip";
        label.textContent = reference.id
          ? `Lead-ID ¬∑ ${reference.id}`
          : `Lead ¬∑ ${reference.name}`;
        leadMeta.appendChild(label);
      }

      function setStatus(message, type = "idle") {
        statusBanner.textContent = message;
        statusBanner.dataset.type = type;
      }

      function setLoading(state) {
        isSending = state;
        sendButton.disabled = state;
        analyzeButton.disabled = state;
      }

      function normalizeLeadValue(value) {
        if (!value) return null;
        const trimmed = value.trim();
        if (!trimmed) return null;
        if (/^\d+$/.test(trimmed)) {
          return { id: trimmed };
        }
        return { name: trimmed };
      }

      function detectLeadReference(message, manualValue) {
        const manual = normalizeLeadValue(manualValue);
        if (manual) return manual;

        if (!message) return null;
        const bracketMatch = message.match(/\[lead:(.+?)\]/i);
        if (bracketMatch) {
          return normalizeLeadValue(bracketMatch[1]);
        }

        const hashMatch = message.match(/#lead[:\s-]*([a-z0-9 _-]{2,50})/i);
        if (hashMatch) {
          return normalizeLeadValue(hashMatch[1]);
        }

        const mentionMatch = message.match(/@([a-z][\w\s'-]{1,50})/i);
        if (mentionMatch) {
          return normalizeLeadValue(mentionMatch[1]);
        }
        return null;
      }

      async function sendChat(options = {}) {
        if (isSending) return;

        const action = options.action || "chat";
        const rawMessage = messageInput.value.trim();
        let message = rawMessage;

        if (!message && action !== "analyze_lead_context") {
          setStatus("Bitte gib zuerst eine Nachricht ein.", "error");
          return;
        }

        if (!message && action === "analyze_lead_context") {
          message = "Bitte analysiere diesen Lead f√ºr mich.";
        }

        const leadReference = detectLeadReference(rawMessage, leadInput.value);
        if (action === "analyze_lead_context" && !leadReference) {
          setStatus("F√ºr eine Analyse ben√∂tige ich den Lead-Namen oder die ID.", "error");
          return;
        }

        const historyForApi = conversation.map((entry) => ({ ...entry }));
        conversation.push({ role: "user", content: message });
        appendBubble("user", message);
        updateLeadMeta(leadReference);
        messageInput.value = "";

        try {
          setLoading(true);
          setStatus("Cloud-Bridge aktiviert ‚Ä¶", "success");
          const response = await fetch("/.netlify/functions/ai", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              action,
              message,
              history: historyForApi,
              lead: leadReference,
            }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "Unbekannter Fehler bei der AI-Bridge.");
          }

          const data = await response.json();
          const reply = (data.reply || "Ich habe aktuell keine Antwort.").trim();
          conversation.push({ role: "assistant", content: reply });
          appendBubble("assistant", reply);

          if (data.leadContext) {
            setStatus("Lead-Kontext injiziert und Strategie erstellt.", "success");
          } else {
            setStatus("Antwort ohne Lead-Kontext gesendet.", "idle");
          }
        } catch (error) {
          console.error(error);
          setStatus(error.message || "Die AI-Bridge ist gerade nicht erreichbar.", "error");
          if (conversation.at(-1)?.role === "user") {
            conversation.pop();
          }
          messageInput.value = rawMessage;
        } finally {
          setLoading(false);
          if (!isSending && statusBanner.dataset.type === "idle") {
            setStatus("Bereit f√ºr deine Fragen.");
          }
          messageInput.focus();
        }
      }

      function updatePlanUI() {
        planBadge.textContent = currentUser.plan;
        planBadge.dataset.plan = currentUser.plan.toLowerCase();
        const isFree = currentUser.plan === "FREE";
        upgradeNavBadge.hidden = !isFree;
        sidebarUpgradeButton.hidden = !isFree;
      }

      function updateBillingToggle() {
        billingButtons.forEach((button) => {
          const isActive = button.dataset.billingInterval === currentBillingInterval;
          button.classList.toggle("active", isActive);
          button.setAttribute("aria-pressed", String(isActive));
        });
      }

      function formatPrice(value) {
        return new Intl.NumberFormat("de-DE").format(value);
      }

      function updatePricingPrices() {
        const multiplier = currentBillingInterval === "month" ? 1 : 12 * 0.8;
        const suffix = currentBillingInterval === "month" ? "/ Monat" : "/ Jahr";
        document.querySelectorAll("[data-plan-price]").forEach((node) => {
          const plan = node.dataset.planPrice;
          const base = planPrices[plan];
          const price = currentBillingInterval === "month"
            ? base
            : Math.round(base * multiplier);
          node.textContent = `‚Ç¨${formatPrice(price)} ${suffix}`;
        });
      }

      function handleCheckoutSuccessFlag() {
        const params = new URLSearchParams(window.location.search);
        if (params.get("success") === "true") {
          setStatus("Upgrade erfolgreich abgeschlossen.", "success");
          successPill.hidden = false;
          setTimeout(() => {
            successPill.hidden = true;
          }, 5000);
          showView("chat");
          params.delete("success");
          const remaining = params.toString();
          const newUrl = `${window.location.pathname}${remaining ? `?${remaining}` : ""}`;
          window.history.replaceState({}, "", newUrl);
        }
      }

      function showView(view) {
        views.forEach((panel) => {
          const isMatch = panel.dataset.viewId === view;
          panel.classList.toggle("active", isMatch);
        });
        navButtons.forEach((button) => {
          const matches = button.dataset.view === view;
          button.classList.toggle("active", matches);
          button.setAttribute("aria-current", matches ? "page" : "false");
        });
      }

      window.showView = showView;

      async function startCheckout(plan, interval = "month") {
        try {
          const response = await fetch("/.netlify/functions/stripe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "create-checkout",
              plan,
              interval,
              userId: currentUser.id,
            }),
          });
          const data = await response.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            setStatus("Checkout konnte nicht gestartet werden.", "error");
          }
        } catch (error) {
          console.error(error);
          setStatus("Checkout ist aktuell nicht erreichbar.", "error");
        }
      }

      updatePlanUI();
      updateBillingToggle();
      updatePricingPrices();
      showView("chat");
      handleCheckoutSuccessFlag();
      messageInput.focus();
    </script>
  </body>
</html>
