<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="salesflow-api-base" content="" />
    <title>Sales Flow AI · Lead Chat</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0d1117;
        --panel: #161b22;
        --accent: #00d8a4;
        --accent-dark: #00a97c;
        --text: #f0f6fc;
        --muted: #8b949e;
        --danger: #ff6575;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #020611, #111b2d 65%, #080c18);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      main {
        display: grid;
        grid-template-columns: 3fr 1.15fr;
        gap: 1.5rem;
        width: min(1200px, 100%);
      }

      section {
        background: rgba(13, 17, 23, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 18px;
        padding: 1.5rem;
        backdrop-filter: blur(8px);
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.35);
      }

      h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .chat-feed {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: 520px;
        overflow-y: auto;
        margin: 1.25rem 0;
        padding-right: 0.5rem;
      }

      .bubble {
        padding: 0.9rem 1rem;
        border-radius: 12px;
        line-height: 1.45;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.05);
        white-space: pre-wrap;
      }

      .bubble.user {
        background: rgba(0, 216, 164, 0.08);
        border-color: rgba(0, 216, 164, 0.4);
        align-self: flex-end;
      }

      .bubble.assistant {
        align-self: flex-start;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      textarea,
      input,
      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(15, 20, 30, 0.8);
        color: inherit;
        padding: 0.9rem 1rem;
        resize: none;
        font-size: 1rem;
      }

      textarea {
        min-height: 110px;
      }

      textarea:focus,
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(0, 216, 164, 0.35);
      }

      .actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      label span {
        display: block;
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 0.35rem;
      }

      label.stacked {
        display: flex;
        flex-direction: column;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
      }

      .quick-modes {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .quick-modes span {
        font-weight: 600;
      }


      button {
        border: none;
        border-radius: 12px;
        padding: 0.9rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button.primary {
        background: var(--accent);
        color: #03150e;
        box-shadow: 0 10px 25px rgba(0, 216, 164, 0.35);
      }

      button.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .quick-modes button {
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.04);
        color: inherit;
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        font-size: 0.85rem;
        box-shadow: none;
      }

      button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 25px rgba(0, 216, 164, 0.4);
      }

      .sidebar h2 {
        margin-top: 0;
        font-size: 1.15rem;
      }

      .sidebar p {
        color: var(--muted);
        line-height: 1.4;
      }

      .status {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.04);
        font-size: 0.9rem;
        min-height: 48px;
        display: flex;
        align-items: center;
      }

      .status[data-type="error"] {
        border-color: rgba(255, 101, 117, 0.35);
        color: var(--danger);
      }

      .status[data-type="success"] {
        border-color: rgba(0, 216, 164, 0.35);
        color: var(--accent);
      }

      .lead-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }

      .muted {
        color: var(--muted);
      }

      .chip {
        padding: 0.4rem 0.75rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.11);
        font-size: 0.85rem;
        background: rgba(255, 255, 255, 0.04);
      }

      .import-panel {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .import-panel h3 {
        margin: 0;
        font-size: 1rem;
      }

      .import-panel textarea {
        min-height: 90px;
      }

      .import-form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .import-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .link-button {
        background: none;
        color: var(--accent);
        padding: 0;
        border: none;
        font-size: 0.9rem;
        font-weight: 600;
        text-align: left;
        cursor: pointer;
      }

      .link-button:hover {
        text-decoration: underline;
      }

      .needs-action-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .needs-action-list li {
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(255, 255, 255, 0.03);
      }

      .needs-action-list strong {
        display: block;
        font-size: 0.95rem;
      }

      .needs-action-meta {
        color: var(--muted);
        font-size: 0.8rem;
      }

      @media (max-width: 980px) {
        body {
          padding: 1rem;
        }

        main {
          grid-template-columns: 1fr;
        }

        .chat-feed {
          height: 360px;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section>
        <header>
          <h1>Sales Flow AI · Chat</h1>
          <p class="muted">Frag nach Taktiken, erwähne Leads via @Name oder #lead:123.</p>
        </header>

        <div id="chatFeed" class="chat-feed"></div>

        <form id="chatForm">
          <label>
            <textarea
              id="messageInput"
              placeholder="Schreibe deine Frage … z. B. „@Sven – was ist der nächste Schritt?“"
            ></textarea>
          </label>

          <label>
            <input
              id="leadInput"
              type="text"
              placeholder="Optional: Lead-Namen oder ID hier einfügen (z. B. 874 oder Marie Cron)"
            />
          </label>

          <div class="form-row">
            <label class="stacked">
              <span>Modus / Intent</span>
              <select id="moduleSelect">
                <option value="general_sales">Sales Flow · Auto</option>
                <option value="einwand_killer">Einwand-Killer</option>
                <option value="speed_hunter_loop">Follow-Up Engine</option>
                <option value="deal_medic">Deal-Medic Analyse</option>
                <option value="screenshot_reactivator">Screenshot-Scanner</option>
                <option value="opportunity_radar">Opportunity Radar</option>
                <option value="portfolio_scanner">Portfolio Scanner</option>
                <option value="client_intake_generator">Client Intake Generator</option>
                <option value="nexus_multi_ki">Nexus Multi-KI</option>
              </select>
            </label>

            <label class="stacked">
              <span>Engine</span>
              <select id="engineSelect">
                <option value="claude">Claude (Strategisch)</option>
                <option value="gpt">GPT (Kreativ)</option>
                <option value="gemini">Gemini (Analytisch)</option>
              </select>
            </label>
          </div>

          <div class="quick-modes">
            <span>Shortcuts:</span>
            <button type="button" data-module="einwand_killer">Einwand-Killer</button>
            <button type="button" data-module="speed_hunter_loop">Follow-Up Engine</button>
            <button type="button" data-module="screenshot_reactivator">Screenshot-Scanner</button>
          </div>

          <div class="actions">
            <button type="submit" class="primary" id="sendButton">Senden</button>
            <button type="button" class="secondary" id="analyzeButton">
              Lead analysieren
            </button>
          </div>
        </form>
      </section>

      <section class="sidebar">
        <h2>Lead-Kontext</h2>
        <p>
          Nutze <code>@Lead</code> oder <code>#lead:ID</code> im Chat oder gib den Namen/ID im Feld
          ein. Der Analyze-Button ruft automatisch die Datenbank auf und injiziert den Kontext in
          den Claude-Prompt.
        </p>

        <div class="status" id="statusBanner" data-type="idle">
          Bereit für deine Fragen.
        </div>

        <div class="lead-meta" id="leadMeta"></div>

        <div class="import-panel">
          <h3>Bestandskunden importieren</h3>
          <p class="muted">
            Lade eine CSV-Datei hoch oder füge die Inhalte unten ein. Die AI erkennt Status,
            letzten Kontakt und schlägt direkt die nächste Aktion vor.
          </p>
          <form id="importForm" class="import-form">
            <label>
              <span>Datei (CSV)</span>
              <input id="importFile" type="file" accept=".csv,text/csv" />
            </label>
            <textarea
              id="importTextarea"
              placeholder="Oder füge hier CSV-Daten ein (name,email,status,notes …)"
            ></textarea>
            <div class="import-actions">
              <button type="submit" class="primary" id="importSubmit">Import starten</button>
              <button type="button" class="secondary" id="importClear">Felder leeren</button>
            </div>
          </form>
          <div class="status" id="importSummary" data-type="idle">
            Noch kein Import durchgeführt.
          </div>
          <button type="button" class="link-button" id="filterNeedsAction">
            Kontakte ohne Status anzeigen
          </button>
          <ul class="needs-action-list" id="needsActionList"></ul>
        </div>
      </section>
    </main>

    <script>
      const chatFeed = document.getElementById("chatFeed");
      const chatForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const leadInput = document.getElementById("leadInput");
      const moduleSelect = document.getElementById("moduleSelect");
      const engineSelect = document.getElementById("engineSelect");
      const statusBanner = document.getElementById("statusBanner");
      const leadMeta = document.getElementById("leadMeta");
      const analyzeButton = document.getElementById("analyzeButton");
      const sendButton = document.getElementById("sendButton");
      const importForm = document.getElementById("importForm");
      const importFileInput = document.getElementById("importFile");
      const importTextarea = document.getElementById("importTextarea");
      const importSummary = document.getElementById("importSummary");
      const importSubmit = document.getElementById("importSubmit");
      const importClearButton = document.getElementById("importClear");
      const needsActionButton = document.getElementById("filterNeedsAction");
      const needsActionList = document.getElementById("needsActionList");

      const apiBaseMeta = document.querySelector('meta[name="salesflow-api-base"]');
      const API_BASE_URL = apiBaseMeta?.content?.trim().replace(/\/$/, "") || "";
      const IMPORT_ENDPOINT = API_BASE_URL ? `${API_BASE_URL}/import/leads` : "/import/leads";
      const NEEDS_ACTION_ENDPOINT = API_BASE_URL
        ? `${API_BASE_URL}/leads/needs-action`
        : "/leads/needs-action";
      const quickModeButtons = document.querySelectorAll("[data-module]");

      const conversation = [];
      let isSending = false;
      let isImporting = false;

      chatForm.addEventListener("submit", (event) => {
        event.preventDefault();
        sendChat();
      });

      analyzeButton.addEventListener("click", () => {
        sendChat({ action: "analyze_lead_context", module: "deal_medic" });
      });

      messageInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendChat();
        }
      });

      importForm?.addEventListener("submit", handleImportSubmit);
      importClearButton?.addEventListener("click", resetImportForm);
      needsActionButton?.addEventListener("click", fetchNeedsActionLeads);
      quickModeButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const mode = button.dataset.module;
          moduleSelect.value = mode;
          setStatus(`Modus gesetzt: ${button.textContent}`, "success");
        });
      });

      function appendBubble(role, text) {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;
        bubble.textContent = text.trim();
        chatFeed.appendChild(bubble);
        chatFeed.scrollTop = chatFeed.scrollHeight;
      }

      function updateLeadMeta(reference) {
        leadMeta.innerHTML = "";
        if (!reference) {
          return;
        }

        const label = document.createElement("div");
        label.className = "chip";
        label.textContent = reference.id
          ? `Lead-ID · ${reference.id}`
          : `Lead · ${reference.name}`;
        leadMeta.appendChild(label);
      }

      function setStatus(message, type = "idle") {
        statusBanner.textContent = message;
        statusBanner.dataset.type = type;
      }

      function setLoading(state) {
        isSending = state;
        sendButton.disabled = state;
        analyzeButton.disabled = state;
      }

      function normalizeLeadValue(value) {
        if (!value) return null;
        const trimmed = value.trim();
        if (!trimmed) return null;
        if (/^\d+$/.test(trimmed)) {
          return { id: trimmed };
        }
        return { name: trimmed };
      }

      function parseLeadIds(value) {
        if (!value) return [];
        return value
          .split(/[,;\n]+/)
          .map((token) => token.trim())
          .filter((token) => token && /^[a-zA-Z0-9_-]+$/.test(token));
      }

      function detectLeadReference(message, manualValue) {
        const manual = normalizeLeadValue(manualValue);
        if (manual) return manual;

        if (!message) return null;
        const bracketMatch = message.match(/\[lead:(.+?)\]/i);
        if (bracketMatch) {
          return normalizeLeadValue(bracketMatch[1]);
        }

        const hashMatch = message.match(/#lead[:\s-]*([a-z0-9 _-]{2,50})/i);
        if (hashMatch) {
          return normalizeLeadValue(hashMatch[1]);
        }

        const mentionMatch = message.match(/@([a-z][\w\s'-]{1,50})/i);
        if (mentionMatch) {
          return normalizeLeadValue(mentionMatch[1]);
        }
        return null;
      }

      async function sendChat(options = {}) {
        if (isSending) return;

        const action = options.action || "chat";
        const moduleOverride = options.module;
        const engineOverride = options.engine;
        const rawMessage = messageInput.value.trim();
        let message = rawMessage;

        if (!message && action !== "analyze_lead_context") {
          setStatus("Bitte gib zuerst eine Nachricht ein.", "error");
          return;
        }

        if (!message && action === "analyze_lead_context") {
          message = "Bitte analysiere diesen Lead für mich.";
        }

        const leadReference = detectLeadReference(rawMessage, leadInput.value);
        const leadIdsSet = new Set(parseLeadIds(leadInput.value));
        if (leadReference?.id) {
          leadIdsSet.add(leadReference.id);
        }
        const leadIdsArray = Array.from(leadIdsSet);

        if (action === "analyze_lead_context" && !leadReference && !leadIdsArray.length) {
          setStatus("Für eine Analyse benötige ich den Lead-Namen oder die ID.", "error");
          return;
        }

        if (moduleOverride && moduleSelect) {
          moduleSelect.value = moduleOverride;
        }

        const historyForApi = conversation.map((entry) => ({ ...entry }));
        conversation.push({ role: "user", content: message });
        appendBubble("user", message);
        const metaReference =
          leadReference || (leadIdsArray[0] ? { id: leadIdsArray[0] } : null);
        updateLeadMeta(metaReference);
        messageInput.value = "";

        try {
          setLoading(true);
          setStatus("Cloud-Bridge aktiviert …", "success");
          const effectiveModule =
            moduleOverride || moduleSelect.value || "general_sales";
          const effectiveEngine =
            engineOverride || engineSelect.value || "claude";

          const payload = {
            action,
            message,
            history: historyForApi,
            lead: leadReference,
            module: effectiveModule,
            engine: effectiveEngine,
            extra: options.extra || {},
          };

          if (leadIdsArray.length) {
            payload.leadIds = leadIdsArray;
            payload.leadId = leadIdsArray[0];
          } else if (leadReference?.id) {
            payload.leadId = leadReference.id;
          }

          const response = await fetch("/.netlify/functions/ai", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || "Unbekannter Fehler bei der AI-Bridge.");
          }

          const data = await response.json();
          const reply = (data.reply || "Ich habe aktuell keine Antwort.").trim();
          conversation.push({ role: "assistant", content: reply });
          appendBubble("assistant", reply);

          if (data.leadContext) {
            setStatus("Lead-Kontext injiziert und Strategie erstellt.", "success");
          } else {
            setStatus("Antwort ohne Lead-Kontext gesendet.", "idle");
          }
        } catch (error) {
          console.error(error);
          setStatus(error.message || "Die AI-Bridge ist gerade nicht erreichbar.", "error");
          if (conversation.at(-1)?.role === "user") {
            conversation.pop();
          }
          messageInput.value = rawMessage;
        } finally {
          setLoading(false);
          if (!isSending && statusBanner.dataset.type === "idle") {
            setStatus("Bereit für deine Fragen.");
          }
          messageInput.focus();
        }
      }

      async function handleImportSubmit(event) {
        event.preventDefault();
        if (isImporting) return;

        const filePayload = await readCsvFromFile();
        const textareaPayload = (importTextarea?.value || "").trim();
        const csvPayload = filePayload || textareaPayload;

        if (!csvPayload) {
          setImportStatus("Bitte wähle eine CSV-Datei oder füge Daten ein.", "error");
          return;
        }

        try {
          isImporting = true;
          setImportLoading(true);
          setImportStatus("Import läuft …", "success");
          const response = await fetch(IMPORT_ENDPOINT, {
            method: "POST",
            headers: {
              "Content-Type": "text/csv",
            },
            body: csvPayload,
          });

          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(errorBody || "Import fehlgeschlagen.");
          }

          const data = await response.json();
          const total = data.total ?? 0;
          const withStatus = data.with_ai_status ?? 0;
          const withoutStatus = data.without_status ?? 0;
          setImportStatus(
            `Import abgeschlossen: ${total} Kontakte (${withStatus} erkannt, ${withoutStatus} offen).`,
            "success"
          );
          fetchNeedsActionLeads();
        } catch (error) {
          console.error(error);
          setImportStatus(error.message || "Import fehlgeschlagen.", "error");
        } finally {
          isImporting = false;
          setImportLoading(false);
        }
      }

      async function readCsvFromFile() {
        if (!importFileInput || !importFileInput.files?.length) {
          return "";
        }
        try {
          return await importFileInput.files[0].text();
        } catch (error) {
          console.error(error);
          return "";
        }
      }

      function setImportStatus(message, type = "idle") {
        if (!importSummary) return;
        importSummary.textContent = message;
        importSummary.dataset.type = type;
      }

      function setImportLoading(state) {
        if (importSubmit) {
          importSubmit.disabled = state;
        }
      }

      function resetImportForm() {
        if (importFileInput) {
          importFileInput.value = "";
        }
        if (importTextarea) {
          importTextarea.value = "";
        }
        setImportStatus("Formular zurückgesetzt. Optional neue CSV wählen.", "idle");
      }

      async function fetchNeedsActionLeads() {
        if (!needsActionList) {
          return;
        }
        needsActionList.innerHTML =
          '<li class="needs-action-meta">Lade Kontakte ohne Status …</li>';
        try {
          const response = await fetch(NEEDS_ACTION_ENDPOINT);
          if (!response.ok) {
            throw new Error("Leads konnten nicht geladen werden.");
          }
          const payload = await response.json();
          renderNeedsActionList(payload.leads || []);
        } catch (error) {
          console.error(error);
          const li = document.createElement("li");
          li.className = "needs-action-meta";
          li.textContent = error.message || "Leads konnten nicht geladen werden.";
          needsActionList.innerHTML = "";
          needsActionList.appendChild(li);
        }
      }

      function renderNeedsActionList(leads) {
        if (!needsActionList) return;
        needsActionList.innerHTML = "";

        if (!Array.isArray(leads) || leads.length === 0) {
          const empty = document.createElement("li");
          empty.className = "needs-action-meta";
          empty.textContent = "Alle importierten Kontakte besitzen bereits einen Status.";
          needsActionList.appendChild(empty);
          return;
        }

        leads.slice(0, 8).forEach((lead) => {
          const item = document.createElement("li");
          const title = document.createElement("strong");
          title.textContent = lead.name || lead.email || "Unbenannter Kontakt";
          item.appendChild(title);

          const meta = document.createElement("div");
          meta.className = "needs-action-meta";
          meta.textContent = buildNeedsActionMeta(lead);
          item.appendChild(meta);

          needsActionList.appendChild(item);
        });
      }

      function buildNeedsActionMeta(lead) {
        const chunks = [];
        if (lead.company) {
          chunks.push(lead.company);
        }
        if (lead.email) {
          chunks.push(lead.email);
        }
        if (lead.last_contact) {
          chunks.push(`Zuletzt: ${lead.last_contact}`);
        }
        return chunks.join(" · ") || "Keine weiteren Infos";
      }

      fetchNeedsActionLeads();
      messageInput.focus();
    </script>
  </body>
</html>
