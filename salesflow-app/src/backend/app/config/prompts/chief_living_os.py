"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  CHIEF LIVING OS PROMPTS                                                  â•‘
â•‘  Context Injection fÃ¼r Override Loop, Commands & Team Rules              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Diese Prompts werden in den CHIEF System Prompt injiziert,
um das selbstlernende Verhalten zu ermÃ¶glichen.
"""

from typing import List, Dict, Any


# =============================================================================
# MAIN LIVING OS PROMPT
# =============================================================================

CHIEF_LIVING_OS_PROMPT = """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[MODUL: LIVING OS - SELF-EVOLVING SYSTEM]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Du bist Teil eines selbstlernenden Sales-Systems. Deine Antworten werden durch
verschiedene Quellen beeinflusst und verbessert.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AKTIVE REGELN (HÃ–CHSTE PRIORITÃ„T)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{active_rules}

Diese Regeln wurden vom User oder seinem Team erstellt und MÃœSSEN beachtet werden.
- ğŸ”´ Personal Rules: Vom User selbst erstellt
- ğŸŸ¡ Team Rules: Vom Team-Leader geteilt
- Priority 90-100: IMMER befolgen
- Priority 50-89: Stark bevorzugen
- Priority < 50: Als Empfehlung behandeln

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
GELERNTE PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{learned_patterns}

Diese Muster wurden aus den Korrekturen des Users erkannt:
- Wende sie an, wenn der Kontext passt
- Sie sind weniger strikt als Regeln
- Bei Unsicherheit: Frage nach oder nutze deinen Standard

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TEAM BEST PRACTICES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

{team_broadcasts}

Diese Strategien haben im Team gut funktioniert:
- Nutze sie als Inspiration
- Du kannst darauf hinweisen: "Das hat bei deinem Team gut funktioniert..."
- Adaptiere sie an den aktuellen Kontext

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""


# =============================================================================
# COMMAND DETECTION PROMPT
# =============================================================================

CHIEF_COMMAND_DETECTION_PROMPT = """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[COMMAND DETECTION]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Wenn der User einen Befehl gibt (erkennbar an "CHIEF", "Ab jetzt", "Regel", "Wenn...dann"):

1. ERKENNE den Befehl
2. BESTÃ„TIGE mit:
   "Verstanden! Ich merke mir: [Zusammenfassung der Regel]
   
   ğŸ“ Soll ich das als Regel speichern?
   - ğŸ‘¤ Nur fÃ¼r mich
   - ğŸ‘¥ FÃ¼rs ganze Team"

3. Bei BestÃ¤tigung: Leite an Command-Service weiter

Beispiel:
User: "CHIEF, ab jetzt bei 'zu teuer' keine Rabatte, immer erst ROI-Fragen"

CHIEF: "Verstanden! Bei Preis-EinwÃ¤nden wie 'zu teuer':
- Keine Rabatte anbieten
- Stattdessen ROI-Fragen stellen ('Was wÃ¤re es dir wert, wenn...')

ğŸ“ Soll ich das als Regel speichern?
ğŸ‘¤ Nur fÃ¼r mich  |  ğŸ‘¥ FÃ¼rs Team"
"""


# =============================================================================
# OVERRIDE ACKNOWLEDGMENT PROMPT
# =============================================================================

CHIEF_OVERRIDE_ACKNOWLEDGMENT_PROMPT = """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[OVERRIDE ERKENNUNG]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Wenn der User deinen Vorschlag stark verÃ¤ndert hat:

- Erkenne die Ã„nderung
- Frage NICHT jedes Mal nach
- Aber bei signifikanten Ã„nderungen (3+ mal Ã¤hnlich):
  
  "Mir fÃ¤llt auf, dass du meine VorschlÃ¤ge oft [kÃ¼rzer machst / direkter formulierst / etc.].
  Soll ich das in Zukunft direkt so machen?"

Dies hilft dem System zu lernen, ohne aufdringlich zu sein.
"""


# =============================================================================
# SKILL LEVEL ADAPTATIONS
# =============================================================================

SKILL_LEVEL_PROMPTS = {
    "rookie": """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[SKILL LEVEL: ROOKIE ğŸŒ±]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Dieser User ist Einsteiger. Deine Aufgabe:
- ErklÃ¤re WARUM etwas funktioniert
- Gib Schritt-fÃ¼r-Schritt Anleitungen
- Warne vor typischen Fehlern
- Sei ermutigend und unterstÃ¼tzend
- Biete komplette NachrichtenvorschlÃ¤ge an
- Nutze mehr Emojis zur Auflockerung

Beispiel-Ton:
"Hey! FÃ¼r den ersten Kontakt empfehle ich dir folgende Nachricht - 
sie funktioniert gut, weil sie neugierig macht ohne aufdringlich zu sein: ..."
""",
    
    "advanced": """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[SKILL LEVEL: ADVANCED âš¡]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Dieser User hat Erfahrung. Deine Aufgabe:
- Schnellere, effizientere VorschlÃ¤ge
- Weniger ErklÃ¤rungen, mehr Action
- Template-Variationen anbieten
- Auf Muster und Optimierungen hinweisen
- Daten-basierte Empfehlungen geben

Beispiel-Ton:
"FÃ¼r Follow-up: Option A (direkt) oder B (soft)? 
Deine Reply-Rate war bei direkten Nachrichten 15% hÃ¶her."
""",
    
    "pro": """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[SKILL LEVEL: PRO ğŸ”¥]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Dieser User ist Experte. Deine Aufgabe:
- Minimaler Output, maximale Wirkung
- Nur essenzielle Infos
- AusfÃ¼hren, nicht erklÃ¤ren
- Auf Befehle reagieren (Command Line)
- Pattern-VorschlÃ¤ge machen wenn erkannt

Beispiel-Ton:
"Done. Nachricht angepasst: [Text]
Neu erkannt: Du verkÃ¼rzt meine VorschlÃ¤ge oft. Als Regel speichern?"
""",
}


# =============================================================================
# FORMATTING FUNCTIONS
# =============================================================================

def format_rules_for_context(rules: List[Dict[str, Any]]) -> str:
    """Formatiert aktive Regeln fÃ¼r CHIEF Context"""
    if not rules:
        return "Keine aktiven Regeln."
    
    lines = []
    for rule in rules[:10]:  # Max 10 rules
        scope_emoji = "ğŸ”´" if rule.get("scope") == "personal" else "ğŸŸ¡"
        priority = rule.get("priority", 50)
        
        trigger = rule.get("trigger_config", {})
        action = rule.get("action_config", {})
        
        trigger_desc = trigger.get("trigger_pattern", ["alle Situationen"])
        if isinstance(trigger_desc, list):
            trigger_desc = ", ".join(trigger_desc[:3])
        
        instruction = action.get("instruction", "")
        
        lines.append(
            f"{scope_emoji} **[P{priority}]** Bei '{trigger_desc}':\n"
            f"   â†’ {instruction}"
        )
        
        # Add example if available
        examples = rule.get("examples", [])
        if examples and isinstance(examples, list) and examples:
            ex = examples[0]
            if isinstance(ex, dict):
                if ex.get('bad'):
                    lines.append(f"   âŒ Nicht: {ex.get('bad', '')}")
                if ex.get('good'):
                    lines.append(f"   âœ… Besser: {ex.get('good', '')}")
    
    return "\n\n".join(lines)


def format_patterns_for_context(patterns: List[Dict[str, Any]]) -> str:
    """Formatiert gelernte Patterns fÃ¼r CHIEF Context"""
    if not patterns:
        return "Noch keine Patterns erkannt."
    
    lines = []
    for pattern in patterns[:5]:  # Max 5 patterns
        success = pattern.get("success_rate", 0) or 0
        success_pct = f"{success * 100:.0f}%" if success else "?"
        
        context = pattern.get("context_filter", {})
        channels = context.get("channels", ["alle"])
        if isinstance(channels, list):
            channels_str = ", ".join(channels)
        else:
            channels_str = str(channels)
        
        pattern_type = pattern.get("pattern_type", "Unbekannt")
        description = pattern.get("pattern_description", "")
        
        lines.append(
            f"â€¢ **{pattern_type}** ({success_pct} Erfolg)\n"
            f"  {description}" if description else f"â€¢ **{pattern_type}** ({success_pct} Erfolg)\n"
            f"  KanÃ¤le: {channels_str}"
        )
    
    return "\n".join(lines)


def format_broadcasts_for_context(broadcasts: List[Dict[str, Any]]) -> str:
    """Formatiert Team Broadcasts fÃ¼r CHIEF Context"""
    if not broadcasts:
        return "Keine Team Best Practices verfÃ¼gbar."
    
    lines = []
    for bc in broadcasts[:3]:  # Max 3 broadcasts
        perf = bc.get("performance_data", {}) or {}
        reply_rate = perf.get("reply_rate", 0) or 0
        improvement = perf.get("improvement_vs_average", "")
        
        title = bc.get("title", "Unbekannt")
        description = bc.get("description", "")
        
        lines.append(
            f"ğŸ“£ **{title}**\n"
            f"   {description}\n"
            f"   Performance: {reply_rate * 100:.0f}% Antwortrate {improvement}"
        )
    
    return "\n\n".join(lines)


def build_living_os_context_prompt(
    rules: List[Dict[str, Any]],
    patterns: List[Dict[str, Any]],
    broadcasts: List[Dict[str, Any]],
    skill_level: str = "advanced",
) -> str:
    """
    Baut den vollstÃ¤ndigen Living OS Prompt.
    
    Args:
        rules: Aktive Regeln
        patterns: Erkannte Patterns
        broadcasts: Team Broadcasts
        skill_level: rookie, advanced, pro
        
    Returns:
        Formatierter Prompt String
    """
    formatted_rules = format_rules_for_context(rules)
    formatted_patterns = format_patterns_for_context(patterns)
    formatted_broadcasts = format_broadcasts_for_context(broadcasts)
    
    # Main prompt
    prompt = CHIEF_LIVING_OS_PROMPT.format(
        active_rules=formatted_rules,
        learned_patterns=formatted_patterns,
        team_broadcasts=formatted_broadcasts,
    )
    
    # Add skill level adaptation
    skill_prompt = SKILL_LEVEL_PROMPTS.get(skill_level, SKILL_LEVEL_PROMPTS["advanced"])
    prompt += "\n" + skill_prompt
    
    # Add command detection for Pro users
    if skill_level == "pro":
        prompt += "\n" + CHIEF_COMMAND_DETECTION_PROMPT
    
    return prompt


def get_override_feedback_message(
    pattern: str,
    occurrence_count: int,
) -> str:
    """
    Generiert Feedback-Nachricht wenn Pattern erkannt wurde.
    
    Args:
        pattern: Der erkannte Pattern-Typ
        occurrence_count: Wie oft das Pattern vorkam
        
    Returns:
        Feedback-Nachricht fÃ¼r den User
    """
    pattern_descriptions = {
        "shorter_more_direct": "kÃ¼rzer und direkter formulierst",
        "longer_more_detailed": "ausfÃ¼hrlicher schreibst",
        "informal_tone": "lockerer/informeller formulierst",
        "formal_tone": "formeller formulierst",
        "emoji_removed": "Emojis entfernst",
        "emoji_added": "mehr Emojis verwendest",
        "question_added": "Fragen hinzufÃ¼gst",
        "no_emojis": "ohne Emojis schreibst",
        "more_questions": "mehr Fragen stellst",
        "casual_friendly": "freundlich-locker formulierst",
    }
    
    desc = pattern_descriptions.get(pattern, f"Ã„nderungen vom Typ '{pattern}' machst")
    
    if occurrence_count >= 5:
        return (
            f"ğŸ’¡ Mir fÃ¤llt auf, dass du meine VorschlÃ¤ge oft {desc}.\n\n"
            f"Soll ich das in Zukunft direkt so machen? Das wÃ¼rde dir Zeit sparen."
        )
    elif occurrence_count >= 3:
        return (
            f"ğŸ“ Ich habe bemerkt, dass du {desc}. "
            f"Bei noch ein paar Ã¤hnlichen Ã„nderungen frage ich, ob ich das automatisch so machen soll."
        )
    
    return ""


# =============================================================================
# CONTEXT INJECTION HELPERS
# =============================================================================

def should_show_command_hint(skill_level: str, message: str) -> bool:
    """
    PrÃ¼ft ob ein Command-Hint gezeigt werden sollte.
    
    FÃ¼r Pro-User zeigen wir Hints wie man Befehle gibt.
    """
    if skill_level != "pro":
        return False
    
    # PrÃ¼fe ob Nachricht wie ein impliziter Befehl aussieht
    indicators = [
        "mach das immer",
        "ab jetzt",
        "in zukunft",
        "merke dir",
        "bei einwand",
        "wenn jemand",
    ]
    
    message_lower = message.lower()
    return any(ind in message_lower for ind in indicators)


def get_command_hint() -> str:
    """Gibt Hint fÃ¼r Command-Nutzung zurÃ¼ck"""
    return (
        "\n\nğŸ’¡ **Tipp:** Du kannst mir auch direkte Befehle geben:\n"
        "`CHIEF, bei [Situation] immer [Aktion]`\n"
        "Dann speichere ich das als Regel."
    )

